name: "kubelet.service"
enabled: true
contents: |
   [Unit]
   Description=Kubelet via Hyperkube ACI
   Wants=rpc-statd.service
   [Service]
   Environment="KUBELET_IMAGE_URL=quay.io/coreos/hyperkube"
   Environment="KUBELET_IMAGE_TAG=v1.9.3_coreos.0"
   Environment="RKT_RUN_ARGS=--uuid-file-save=/var/cache/kubelet-pod.uuid \
     --volume=resolv,kind=host,source=/etc/resolv.conf \
     --mount volume=resolv,target=/etc/resolv.conf \
     --volume var-lib-cni,kind=host,source=/var/lib/cni \
     --mount volume=var-lib-cni,target=/var/lib/cni \
     --volume var-lib-kubelet,kind=host,source=/var/lib/kubelet \
     --mount volume=var-lib-kubelet,target=/var/lib/kubelet \
     --volume var-log,kind=host,source=/var/log \
     --mount volume=var-log,target=/var/log"

   ExecStartPre=/bin/mkdir -p /etc/kubernetes/manifests
   ExecStartPre=/bin/mkdir -p /srv/kubernetes/manifests
   ExecStartPre=/bin/mkdir -p /etc/kubernetes/checkpoint-secrets
   ExecStartPre=/bin/mkdir -p /etc/kubernetes/cni/net.d
   ExecStartPre=/bin/mkdir -p /var/lib/cni
   ExecStartPre=/bin/mkdir -p /var/lib/kubelet/pki

   ExecStartPre=/usr/bin/bash -c "grep 'certificate-authority-data' /etc/kubernetes/kubeconfig | awk '{print $2}' | base64 -d > /etc/kubernetes/ca.crt"
   ExecStartPre=-/usr/bin/rkt rm --uuid-file=/var/cache/kubelet-pod.uuid

   ExecStart=/usr/lib/coreos/kubelet-wrapper \
     --kubeconfig=/etc/kubernetes/kubeconfig \
     --rotate-certificates \
     --require-kubeconfig \
     --cni-conf-dir=/etc/kubernetes/cni/net.d \
     --cni-bin-dir=/var/lib/cni/bin \
     --network-plugin=cni \
     --lock-file=/var/run/lock/kubelet.lock \
     --exit-on-lock-contention \
     --pod-manifest-path=/etc/kubernetes/manifests \
     --allow-privileged \
     --node-labels=node-role.kubernetes.io/master \
     --minimum-container-ttl-duration=6m0s \
     --cluster-dns={{.ClusterDNSIP}} \
     --cluster-domain=cluster.local \
     --client-ca-file=/etc/kubernetes/ca.crt \
     --cloud-provider={{.CloudProvider}} \
     --anonymous-auth=false

   ExecStop=-/usr/bin/rkt stop --uuid-file=/var/cache/kubelet-pod.uuid

   Restart=always
   RestartSec=10

   [Install]
   WantedBy=multi-user.target
